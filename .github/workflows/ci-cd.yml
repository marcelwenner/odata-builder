name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22'

jobs:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # SETUP & PREPARATION
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ env.NODE_VERSION }}
      is-release: ${{ github.event_name == 'release' }}
      is-main: ${{ github.ref == 'refs/heads/main' }}
      is-pr: ${{ github.event_name == 'pull_request' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Log Release Info
        if: github.event_name == 'release'
        run: |
          echo "Release event detected"
          echo "Tag: ${{ github.event.release.tag_name }}"
          echo "Using OIDC Trusted Publishing for NPM authentication"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # CODE QUALITY GATE
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  quality-gate:
    name: Quality Gate
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Lint Code
        run: npm run lint

      - name: Check Format
        run: npm run format -- --check
        continue-on-error: true

      - name: Security Audit
        if: needs.setup.outputs.is-main == 'true' || needs.setup.outputs.is-pr == 'true'
        run: |
          echo "Running security audit..."

          # Check for high and critical vulnerabilities (fail CI)
          if npm audit --audit-level=high --dry-run; then
            echo "No high or critical vulnerabilities found"
          else
            echo "High or critical security vulnerabilities detected!"
            npm audit --audit-level=high
            exit 1
          fi

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # COMPREHENSIVE TESTING
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  test-matrix:
    name: Test Node.js ${{ matrix.node }} on ${{ matrix.os }}
    needs: [setup, quality-gate]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        node: [20, 22]
        os: [ubuntu-latest]
        include:
          - node: 22
            os: ubuntu-latest
            coverage: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        run: npm test

      - name: Generate Coverage
        if: matrix.coverage
        run: npm run coverage:ci

      - name: Upload Coverage
        if: matrix.coverage && hashFiles('./coverage/lcov.info') != ''
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
        continue-on-error: true

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # BUILD & VERIFICATION
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build:
    name: Build & Package
    needs: [setup, quality-gate, test-matrix]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.package-info.outputs.version }}
      package-name: ${{ steps.package-info.outputs.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build

      - name: Verify Build Artifacts
        run: |
          # Check dist directory exists and is not empty
          if [[ ! -d "dist" ]] || [[ -z "$(ls -A dist/)" ]]; then
            echo "Build failed - dist directory is empty or missing"
            exit 1
          fi

          # Check required files exist
          required_files=("odata-builder.js" "odata-builder.esm.js" "odata-builder.d.ts")
          for file in "${required_files[@]}"; do
            if [[ ! -f "dist/$file" ]]; then
              echo "Missing required file: $file"
              exit 1
            fi
          done

          echo "Build output:"
          ls -la dist/
          echo ""
          echo "Bundle sizes:"
          du -h dist/*

      - name: Extract Package Info
        id: package-info
        run: |
          VERSION=$(jq -r '.version' package.json)
          NAME=$(jq -r '.name' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "Package: $NAME@$VERSION"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.run_id }}
          path: dist/
          retention-days: 30

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # RELEASE PIPELINE
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  release-validation:
    name: Release Validation
    if: github.event_name == 'release'
    needs: [setup, build]
    runs-on: ubuntu-latest
    outputs:
      validated: ${{ steps.validate.outputs.valid }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Version Consistency
        id: validate
        run: |
          PACKAGE_VERSION="${{ needs.build.outputs.version }}"
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          TAG_VERSION=${RELEASE_TAG#v}

          echo "Package version: $PACKAGE_VERSION"
          echo "Release tag: $RELEASE_TAG"

          if [[ "$PACKAGE_VERSION" != "$TAG_VERSION" ]]; then
            echo "VERSION MISMATCH!"
            echo "Package: $PACKAGE_VERSION, Tag: $TAG_VERSION"
            exit 1
          fi

          # Validate semantic versioning
          if [[ ! "$PACKAGE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: $PACKAGE_VERSION"
            exit 1
          fi

          # Check if version already exists on NPM
          PACKAGE_NAME="${{ needs.build.outputs.package-name }}"
          if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version >/dev/null 2>&1; then
            echo "Version $PACKAGE_VERSION already exists on NPM!"
            exit 1
          fi

          echo "Version validation passed: v$PACKAGE_VERSION"
          echo "valid=true" >> $GITHUB_OUTPUT

  release-publish:
    name: Publish to NPM
    if: github.event_name == 'release'
    needs: [setup, build, release-validation]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    environment:
      name: npm-registry
      url: https://www.npmjs.com/package/${{ needs.build.outputs.package-name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            package.json
            README.md
            LICENSE
            CHANGELOG.md

      - name: Setup Node.js for NPM
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          registry-url: 'https://registry.npmjs.org'

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.run_id }}
          path: ./dist

      - name: Prepare NPM Package
        run: |
          # Copy package files to dist
          cp package.json dist/
          cp README.md dist/
          [[ -f LICENSE ]] && cp LICENSE dist/
          [[ -f CHANGELOG.md ]] && cp CHANGELOG.md dist/

          cd dist

          # Update package.json paths for NPM
          jq '.main = "odata-builder.js"' package.json > tmp.json && mv tmp.json package.json
          jq '.module = "odata-builder.esm.js"' package.json > tmp.json && mv tmp.json package.json
          jq '.types = "odata-builder.d.ts"' package.json > tmp.json && mv tmp.json package.json

          # Remove dev-only fields
          jq 'del(.devDependencies, .scripts)' package.json > tmp.json && mv tmp.json package.json

      - name: Publish to NPM
        run: |
          cd dist
          npm publish --access public --provenance
          echo "Successfully published ${{ needs.build.outputs.package-name }}@${{ needs.build.outputs.version }}"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # PIPELINE SUMMARY
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  pipeline-status:
    name: Pipeline Summary
    if: always()
    needs: [setup, quality-gate, test-matrix, build, release-validation, release-publish]
    runs-on: ubuntu-latest
    steps:
      - name: Generate Pipeline Summary
        run: |
          echo "# CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Setup | ${{ needs.setup.result == 'success' && 'Success' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gate | ${{ needs.quality-gate.result == 'success' && 'Success' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Matrix | ${{ needs.test-matrix.result == 'success' && 'Success' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'Success' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "| Release Validation | ${{ needs.release-validation.result == 'success' && 'Success' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| NPM Publish | ${{ needs.release-publish.result == 'success' && 'Success' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Final Status Check
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "Pipeline failed"
            exit 1
          fi
          echo "Pipeline completed successfully"
