name: Workflow

on:
    push:
        tags:
            - 'v*'
        branches:
            - '**'
    pull_request:
        branches:
            - '**'
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    pr-checks:
        if: ${{ github.event_name == 'pull_request' }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Check branch name
              if: ${{ github.event_name == 'pull_request' }}
              run: |
                  BRANCH_NAME=${{ github.event.pull_request.head.ref }}
                  if [[ ! "$BRANCH_NAME" =~ ^(feature|bugfix|hotfix|dependabot)/.+$ ]]; then
                    echo "Branch name must follow the pattern 'feature/*', 'bugfix/*', or 'hotfix/*'."
                    exit 1
                  fi

            - name: Check for tags in PR
              run: |
                  echo "Checking for tags on all commits in the PR..."
                  git fetch --tags --quiet
                  for COMMIT in $(git rev-list ${{ github.event.pull_request.base.sha }}..${{ github.sha }}); do
                    if git tag --points-at $COMMIT | grep -q .; then
                      echo "Tag found on commit $COMMIT. Tags are not allowed in PRs."
                      exit 1
                    fi
                  done
                  echo "No tags found on any commits in the PR."

            - name: Check for required labels
              run: |
                  echo "Checking for required labels ('ready-for-review' or 'dependencies')..."
                  if ! curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                    https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }} | \
                    jq -e '.labels[].name | select(. == "ready-for-review" or . == "dependencies")' > /dev/null 2>&1; then
                    echo "PR must have either the 'ready-for-review' or 'dependencies' label."
                    exit 1
                  fi

    check-secrets:
        runs-on: ubuntu-latest
        steps:
            - name: Skip for Dependabot
              if: github.actor == 'dependabot[bot]'
              run: echo "Skipping secret verification for Dependabot."

            - name: Verify required secrets
              if: github.actor != 'dependabot[bot]'
              run: |
                  echo "Verifying required secrets..."
                  REQUIRED_SECRETS=("GITHUB_TOKEN" "NPM_TOKEN")
                  for SECRET in "${REQUIRED_SECRETS[@]}"; do
                    if [ -z "${!SECRET}" ]; then
                      echo "Error: Required secret $SECRET is not set."
                      exit 1
                    fi
                  done
                  echo "All required secrets are set."
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
              shell: bash

    test:
        needs: check-secrets
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [18, 20]
        steps:
            - uses: actions/checkout@v3
            - name: Set up Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node-version }}
            - name: Cache Node.js modules
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-${{ matrix.node-version }}-
            - name: Install dependencies
              run: npm ci
            - name: Run tests with coverage
              id: run-tests
              run: npm run test -- --coverage --reporter=json --reporter=default --outputFile=test-results.json

            - name: Generate test summary and coverage
              if: ${{ github.event_name == 'pull_request' }}
              run: |
                  TEST_SUMMARY=$(cat test-results.json | jq -r '
                  {
                    "total": (.numTotalTests),
                    "passed": (.numPassedTests),
                    "failed": (.numFailedTests),
                    "pass_rate": (if (.numTotalTests) > 0 then (.numPassedTests / (.numPassedTests + .numFailedTests) * 100 | floor) else 100 end)
                  }')
                  echo "TEST_SUMMARY_TOTAL=$(echo "$TEST_SUMMARY" | jq -r '.total')" >> $GITHUB_ENV
                  echo "TEST_SUMMARY_PASSED=$(echo "$TEST_SUMMARY" | jq -r '.passed')" >> $GITHUB_ENV
                  echo "TEST_SUMMARY_FAILED=$(echo "$TEST_SUMMARY" | jq -r '.failed')" >> $GITHUB_ENV
                  echo "TEST_SUMMARY_PASS_RATE=$(echo "$TEST_SUMMARY" | jq -r '.pass_rate')" >> $GITHUB_ENV

            - name: Generate test coverage summary with insights
              if: ${{ github.event_name == 'pull_request' }}
              run: |
                  COVERAGE_OUTPUT=$(npm run coverage:ci | grep "All files" | awk -F'|' '
                    {
                      statements=$2+0;
                      branches=$3+0;
                      functions=$4+0;
                      lines=$5+0;

                      if (statements == 100) statements_insight="üöÄ Excellent coverage!";
                      else if (statements >= 90) statements_insight="‚úÖ Great coverage, keep it up!";
                      else if (statements >= 75) statements_insight="‚ö†Ô∏è Good coverage, but improvements are possible.";
                      else statements_insight="‚ùå Coverage needs improvement.";

                      if (branches == 100) branches_insight="üöÄ Excellent coverage!";
                      else if (branches >= 90) branches_insight="‚úÖ Great coverage, keep it up!";
                      else if (branches >= 75) branches_insight="‚ö†Ô∏è Good coverage, but improvements are possible.";
                      else branches_insight="‚ùå Coverage needs improvement.";

                      if (functions == 100) functions_insight="üöÄ Excellent coverage!";
                      else if (functions >= 90) functions_insight="‚úÖ Great coverage, keep it up!";
                      else if (functions >= 75) functions_insight="‚ö†Ô∏è Good coverage, but improvements are possible.";
                      else functions_insight="‚ùå Coverage needs improvement.";

                      if (lines == 100) lines_insight="üöÄ Excellent coverage!";
                      else if (lines >= 90) lines_insight="‚úÖ Great coverage, keep it up!";
                      else if (lines >= 75) lines_insight="‚ö†Ô∏è Good coverage, but improvements are possible.";
                      else lines_insight="‚ùå Coverage needs improvement.";

                      printf "### Coverage Summary with Insights\\n";
                      printf "| Metric      | Coverage | Insights                          |\\n";
                      printf "|-------------|----------|-----------------------------------|\\n";
                      printf "| Statements  | %s       | %s |\\n", $2, statements_insight;
                      printf "| Branches    | %s       | %s |\\n", $3, branches_insight;
                      printf "| Functions   | %s       | %s |\\n", $4, functions_insight;
                      printf "| Lines       | %s       | %s |\\n", $5, lines_insight;
                    }')

                  echo "COVERAGE<<EOF" >> $GITHUB_ENV
                  echo "$COVERAGE_OUTPUT" >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Post test summary and coverage to PR
              if: ${{ github.event_name == 'pull_request' }}
              uses: marocchino/sticky-pull-request-comment@v2
              with:
                  header: üöÄ Test Results (Node ${{ matrix.node-version }})
                  message: |
                      # üöÄ Test Results (Node ${{ matrix.node-version }})

                      ## üõ† **Summary**
                      | Metric         | Value                                   |
                      |----------------|-----------------------------------------|
                      | **Total Tests**| üß™ ${{ env.TEST_SUMMARY_TOTAL }}        |
                      | **Passed**     | ‚úÖ ${{ env.TEST_SUMMARY_PASSED }}       |
                      | **Failed**     | ‚ùå ${{ env.TEST_SUMMARY_FAILED }}       |
                      | **Pass Rate**  | üü¢ **${{ env.TEST_SUMMARY_PASS_RATE }}%** |

                      ## üìä **Coverage Details**
                      <details>
                      <summary>üîç Click to expand</summary>

                      ```plaintext
                      ${{ env.COVERAGE }}
                      ```

                      </details>

                      ---
                      > *Generated automatically by CI Pipeline*
                  operationType: upsert

            - name: Upload full test output as artifact
              if: ${{ github.event_name == 'pull_request' }}
              uses: actions/upload-artifact@v3
              with:
                  name: full-test-output-${{ matrix.node-version }}
                  path: test-results.json

    lint:
        needs: check-secrets
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [18, 20]
        steps:
            - uses: actions/checkout@v3
            - name: Set up Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node-version }}
            - name: Cache Node.js modules
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-${{ matrix.node-version }}-
            - name: Install dependencies
              run: npm ci
            - name: Run linting
              id: eslint-check
              run: npm run lint -- --format json --output-file eslint-results.json
              continue-on-error: true # Allow the workflow to continue even if there are linting errors

            - name: Load ESLint results
              id: load-eslint-results
              if: ${{ github.event_name == 'pull_request' }}
              uses: actions/github-script@v6
              with:
                  script: |
                      const fs = require('fs');
                      const resultsPath = 'eslint-results.json';
                      if (fs.existsSync(resultsPath)) {
                        const rawResults = fs.readFileSync(resultsPath, 'utf8');
                        const results = JSON.parse(rawResults);
                        const annotations = results.flatMap(fileResult =>
                          fileResult.messages.map(message => ({
                            path: fileResult.filePath.substring(process.env.GITHUB_WORKSPACE.length + 1),
                            start_line: message.line,
                            end_line: message.line,
                            start_column: message.column,
                            end_column: message.column,
                            annotation_level: message.severity === 2 ? 'failure' : 'warning',
                            message: `${message.message} (${message.ruleId})`,
                            title: 'ESLint Violation',
                          }))
                        );
                        core.setOutput('eslint_annotations', annotations);
                      } else {
                        core.setOutput('eslint_annotations', []);
                      }

            - name: Post ESLint results to PR
              if: ${{ github.event_name == 'pull_request' && steps.load-eslint-results.outputs.eslint_annotations != '[]' }}
              uses: actions/github-script@v6
              with:
                  script: |
                      const annotations = JSON.parse(core.getOutput('eslint_annotations'));
                      const conclusion = annotations.length > 0 ? 'failure' : 'success';
                      const summary = annotations.length > 0
                        ? `ESLint found ${annotations.length} areas for improvement. See the annotations below for details on how to align with our code style.`
                        : 'ESLint found no issues. Great job keeping the code clean!';

                      await github.rest.checks.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        name: 'ESLint Check',
                        head_sha: context.payload.pull_request.head.sha,
                        status: 'completed',
                        conclusion: conclusion,
                        output: {
                          title: 'ESLint Results',
                          summary: summary,
                          annotations: annotations,
                        },
                      });

    audit:
        needs: check-secrets
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Set up Node.js 20
              uses: actions/setup-node@v3
              with:
                  node-version: '20'
            - name: Cache Node.js modules
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-
            - name: Install dependencies
              run: npm ci
            - name: Run audit
              id: npm-audit
              run: npm audit --production --json > npm-audit-results.json
              continue-on-error: true

            - name: Check for audit errors
              id: check-audit-errors
              if: ${{ github.event_name == 'pull_request' }}
              run: |
                  NPM_AUDIT_OUTPUT=$(cat npm-audit-results.json)

                  INFO=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.info')
                  LOW=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.low')
                  MODERATE=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.moderate')
                  HIGH=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.high')
                  CRITICAL=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.critical')
                  TOTAL=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.total')

                  PROD=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.dependencies.prod')
                  DEV=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.dependencies.dev')
                  OPTIONAL=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.dependencies.optional')
                  PEER=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.dependencies.peer')
                  PEER_OPTIONAL=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.dependencies.peerOptional')
                  DEP_TOTAL=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.dependencies.total')

                  echo "NPM_AUDIT_INFO=$INFO" >> $GITHUB_ENV
                  echo "NPM_AUDIT_LOW=$LOW" >> $GITHUB_ENV
                  echo "NPM_AUDIT_MODERATE=$MODERATE" >> $GITHUB_ENV
                  echo "NPM_AUDIT_HIGH=$HIGH" >> $GITHUB_ENV
                  echo "NPM_AUDIT_CRITICAL=$CRITICAL" >> $GITHUB_ENV
                  echo "NPM_AUDIT_TOTAL=$TOTAL" >> $GITHUB_ENV

                  echo "NPM_AUDIT_PROD=$PROD" >> $GITHUB_ENV
                  echo "NPM_AUDIT_DEV=$DEV" >> $GITHUB_ENV
                  echo "NPM_AUDIT_OPTIONAL=$OPTIONAL" >> $GITHUB_ENV
                  echo "NPM_AUDIT_PEER=$PEER" >> $GITHUB_ENV
                  echo "NPM_AUDIT_PEER_OPTIONAL=$PEER_OPTIONAL" >> $GITHUB_ENV
                  echo "NPM_AUDIT_DEP_TOTAL=$DEP_TOTAL" >> $GITHUB_ENV

                  if [[ $TOTAL -gt 0 ]]; then
                    echo "NPM_AUDIT_HAS_ERRORS=true" >> $GITHUB_ENV
                    echo "STATUS=üö® **Vulnerabilities detected!** Please address the issues listed above." >> $GITHUB_ENV
                  else
                    echo "NPM_AUDIT_HAS_ERRORS=false" >> $GITHUB_ENV
                    echo "STATUS=üöÄ **No vulnerabilities found.** Excellent job keeping dependencies secure! üéâ" >> $GITHUB_ENV
                  fi

            - name: Post npm audit results to PR
              if: ${{ github.event_name == 'pull_request' }}
              uses: marocchino/sticky-pull-request-comment@v2
              with:
                  header: üîí NPM Audit Findings
                  message: |
                      # üîí **NPM Audit Findings**

                      ## üö¶ **Vulnerability Summary**
                      | **Severity**     | **Count**                           |
                      |------------------|-------------------------------------|
                      | üü¢ **Info**      | `${{ env.NPM_AUDIT_INFO }}`         |
                      | üü° **Low**       | `${{ env.NPM_AUDIT_LOW }}`          |
                      | üü† **Moderate**  | `${{ env.NPM_AUDIT_MODERATE }}`     |
                      | üî¥ **High**      | `${{ env.NPM_AUDIT_HIGH }}`         |
                      | üî• **Critical**  | `${{ env.NPM_AUDIT_CRITICAL }}`     |

                      ## ‚úÖ **Status**
                      ${{ env.STATUS }}

                      ## üì¶ **Dependency Overview**
                      | **Dependency Type** | **Count**                        |
                      |---------------------|----------------------------------|
                      | üèóÔ∏è **Production**   | `${{ env.NPM_AUDIT_PROD }}`      |
                      | üõ†Ô∏è **Development**  | `${{ env.NPM_AUDIT_DEV }}`       |
                      | üé≤ **Optional**     | `${{ env.NPM_AUDIT_OPTIONAL }}`  |
                      | ü§ù **Peer**         | `${{ env.NPM_AUDIT_PEER }}`      |
                      | ü§ù **Peer Optional**| `${{ env.NPM_AUDIT_PEER_OPTIONAL }}` |
                      | üì¶ **Total**        | `${{ env.NPM_AUDIT_DEP_TOTAL }}` |

                      ---
                      > üîó *Generated automatically by the CI pipeline to keep your dependencies secure.*
                  operationType: upsert

    build:
        needs: [test, lint, audit]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Set up Node.js 20
              uses: actions/setup-node@v3
              with:
                  node-version: '20'
            - name: Cache Node.js modules
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-
            - name: Cache build outputs
              uses: actions/cache@v3
              with:
                  path: dist/
                  key: ${{ runner.os }}-dist-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-dist-
            - name: Install dependencies
              run: npm ci
            - name: Build
              run: npm run build
            - name: Prepare package for npm
              run: |
                  cp package.json dist/package.json
                  cp README.md dist/README.md
                  cd dist
                  jq '.main = "odata-builder.js"' package.json > tmp.json && mv tmp.json package.json
                  jq '.module = "odata-builder.esm.js"' package.json > tmp.json && mv tmp.json package.json
                  jq '.types = "odata-builder.d.ts"' package.json > tmp.json && mv tmp.json package.json

            - name: Check if dist directory is empty
              id: check-dist
              run: |
                  if [ -z "$(ls -A dist/)" ]; then
                    echo "No files found in dist directory, failing the job."
                    exit 1
                  fi

            - name: Sanitize ref name
              if: github.event_name == 'push'
              run: |
                  echo "SANITIZED_REF_NAME=${GITHUB_REF_NAME//\//_}" >> $GITHUB_ENV

            - name: Archive build artifacts
              if: github.event_name == 'push'
              uses: actions/upload-artifact@v4
              with:
                  name: dist-${{ github.run_id }}-${{ env.SANITIZED_REF_NAME }}
                  path: dist/

    create-release:
        needs: [build]
        if: startsWith(github.ref, 'refs/tags/') && github.base_ref == 'main'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Check version consistency
              run: |
                  PACKAGE_VERSION=$(jq -r .version package.json)
                  TAG_VERSION=${GITHUB_REF#refs/tags/v}
                  if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
                    echo "Version mismatch: package.json ($PACKAGE_VERSION) != tag ($TAG_VERSION)"
                    exit 1
                  fi
              env:
                  GITHUB_REF: ${{ github.ref }}
            - name: Generate release notes
              run: |
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^)
                  git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" > release-notes.md
            - name: Create GitHub Release
              uses: actions/create-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  release_name: ${{ github.ref_name }}
                  body_path: ./release-notes.md
                  draft: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    request-approval:
        needs: [create-release]
        if: startsWith(github.ref, 'refs/tags/') && github.base_ref == 'main'
        runs-on: ubuntu-latest
        environment:
            name: production
        steps:
            - name: Wait for approval
              run: echo "Approval required to proceed to the next job. Check the artifacts and approve if everything is okay."

    publish:
        needs: [request-approval]
        if: startsWith(github.ref, 'refs/tags/') && github.base_ref == 'main'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: dist-${{ github.run_id }}-${{ github.ref_name }}
                  path: dist
            - name: Use Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'
                  registry-url: 'https://registry.npmjs.org'
            - name: Publish to NPM
              run: cd dist && npm publish --access public
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
